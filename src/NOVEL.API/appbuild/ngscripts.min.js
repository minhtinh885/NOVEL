var app=angular.module("NovelApp",["ngRoute","ngResource","ui.bootstrap","toaster","chieffancypants.loadingBar","LocalStorageModule"]);app.config(["$routeProvider",function(o){o.when("/home",{controller:"homeController",templateUrl:"app/views/home.html"}),o.when("/login",{controller:"loginController",templateUrl:"app/views/login.html"}),o.when("/signup",{controller:"signupController",templateUrl:"app/views/signup.html"}),o.when("/books",{controller:"bookController",templateUrl:"app/views/books.html"}),o.otherwise({redirectTo:"/home"})}]),app.config(function(o){o.interceptors.push("authInterceptorService")}),app.run(["authService",function(o){o.fillAuthData()}]),app.controller("bookController",["$scope","booksService","$filter","$modal",function(o,t,e,n){o.init=function(){o.books=[],o.getBooks()},o.bookCompleted=function(t,e){o.books=t.books},o.bookError=function(o,t){},o.getBooks=function(){t.getBooks(o.bookCompleted,o.bookError)},o.getBooksById=function(){book=o.createBookOject(),t.getBooks(book,o.bookCompleted,o.bookError)},o.getBooksByCategoryId=function(){category=o.createCategoryOject(),t.getBooks(category,o.bookCompleted,o.bookError)},o.getBooksByAuthorId=function(){author=o.createAuthorOject(),t.getBooks(author,o.bookCompleted,o.bookError)},o.getBooks=function(){t.getBooks(o.bookCompleted,o.bookError)},o.createBookOject=function(){var o=new Object;return o},o.createCategoryOject=function(){var o=new Object;return o},o.createAuthorOject=function(){var o=new Object;return o},o.showBookModal=function(o){t.getBooksWithId(o,function(o,t){n.open({templateUrl:"app/views/BookModal.html",controller:"bookModalController",resolve:{}},function(o,t){})})}}]),app.controller("bookModalController",["$scope","$modalInstance",function(o,t){o.close=function(){t.dismiss("cancel")}}]),app.controller("homeController",["$scope",function(o){}]),app.controller("indexController",["$scope","$location","authService",function(o,t,e){o.logOut=function(){e.logOut(),t.path("/home")},o.authentication=e.authentication}]),app.controller("loginController",["$scope","$location","authService",function(o,t,e){o.loginData={userName:"",password:""},o.message="",o.login=function(){e.login(o.loginData).then(function(o){t.path("/home")},function(t){o.message=t.error_description})}}]),app.controller("signupController",["$scope","$location","$timeout","authService",function(o,t,e,n){o.savedSuccessfully=!1,o.message="",o.initializeController=function(){o.Email="",o.FirstName="",o.LastName="",o.Password="",o.ConfirmPassword="",o.UserName=""},o.createUser=function(){var t=new Object;return t.Email=o.Email,t.FirstName=o.FirstName,t.LastName=o.LastName,t.Password=o.Password,t.ConfirmPassword=o.ConfirmPassword,t.UserName=o.UserName,t},o.createCompleted=function(o){},o.createError=function(o){},o.signUp=function(){var t=o.createUser();n.saveRegistration(t).then(function(t){o.savedSuccessfully=!0,o.message="Tài khoản đã được đăng ký thành công, Chuyển đến trang đăng nhập trong 5 giây.",r()},function(t){var e=[];for(var n in t.data.modelState)for(var r=0;r<t.data.modelState[n].length;r++)e.push(t.data.modelState[n][r]);o.message="Lỗi khi đăng ký: "+e.join(" ")})};var r=function(){var o=e(function(){e.cancel(o),t.path("/login")},5e3)}}]),app.service("ajaxService",["$http",function(o){this.ajaxPost=function(t,e,n,r){o.post(e,t).success(function(o,t,e,r){n(o,t)}).error(function(o){0==reponse.IsAuthenticated,r(o)})},this.ajaxPostWithNoAuthentication=function(t,e,n,r){o.post(e,t).success(function(o,t,e,r){n(o,t)}).error(function(o){r(o)})},this.ajaxGet=function(t,e,n){o({method:"GET",url:t}).success(function(o,t,n,r){e(o,t)}).error(function(o){n(o)})},this.ajaxGetWithData=function(t,e,n,r){o({method:"GET",url:e,params:t}).success(function(o,t,e,r){n(o,t)}).error(function(o){r(o)})}}]),app.factory("authInterceptorService",["$q","$location","localStorageService",function(o,t,e){var n={},r=function(o){o.headers=o.header||{};var t=e.get("authorizationData");return t&&(o.headers.Authorization="Bearer "+t.token),o},a=function(e){return 401===e.status&&t.path("/login"),o.reject(e)};return n.request=r,n.responseError=a,n}]),app.service("booksService",["$http","ajaxService",function(o,t,e){this.getAuthors=function(o,e){t.ajaxGet("api/authors",o,e)},this.getAuthorsWithId=function(o,e){t.ajaxGetWithData(authorId,"api/authors",o,e)},this.createAuthor=function(o,e,n){t.ajaxPost(o,"api/authors/CreateAuthor",e,n)},this.updateBook=function(o,e,n){t.ajaxPost(o,"api/authors/UpdateAuthor",e,n)}}]),app.factory("authService",["$http","$q","localStorageService",function(o,t,e){var n="",r={},a={isAuth:!1,userName:""},i=function(t){return u(),o.post(n+"api/accounts/CreateUser",t,{headers:[{"Content-Type":"application/json"}]}).then(function(o){return o})},s=function(){o.get(n+"api/accounts").then(function(o){return o})},c=function(r){var i="grant_type=password&username="+r.userName+"&password="+r.password,s=t.defer();return o.post(n+"oauth/token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(o){e.set("authorizationData",{token:o.access_token,userName:r.userName}),a.isAuth=!0,a.userName=r.userName,s.resolve(o)}).error(function(o,t){u(),s.reject(o)}),s.promise},u=function(){e.remove("authorizationData"),a.isAuth=!1,a.userName=""},l=function(){var o=e.get("authorizationData");o&&(a.isAuth=!0,a.userName=o.userName)};return r.saveRegistration=i,r.login=c,r.logOut=u,r.fillAuthData=l,r.authentication=a,r.getUsers=s,r}]),app.service("booksService",["$http","ajaxService",function(o,t,e){this.getBooks=function(o,e){t.ajaxGet("api/books",o,e)},this.getBooksWithCategory=function(o,e){t.ajaxGetWithData(categoryId,"api/books/GetBooksByCategory",o,e)},this.getBooksWithAuthor=function(o,e){t.ajaxGetWithData(authorId,"api/books/GetBooksByAuthor",o,e)},this.getBooksWithId=function(o,e,n){t.ajaxGetWithData(o,"api/books",e,n)},this.createBook=function(o,e,n){t.ajaxPost(o,"api/books/CreateBook",e,n)},this.updateBook=function(o,e,n){t.ajaxPost(o,"api/books/UpdateBook",e,n)}}]);